<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SearchBarbara</title>
  <link rel="stylesheet" href="/static/styles_v2.css" />
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <div>
        <h1>SearchBarbara</h1>
        <p class="subtitle">Thinking-partner mode</p>
      </div>
      <div class="auth-box">
        <span class="muted">{{ user_email }}</span>
        <form method="post" action="/logout">
          <button type="submit">Logout</button>
        </form>
      </div>
      <div class="top-metrics">
        <div><span class="k">Run</span><span id="runStatus">idle</span></div>
        <div><span class="k">Research</span><span id="researchStatus">idle</span></div>
        <div><span class="k">Report</span><span id="reportStatus">pending</span></div>
        <div><span class="k">Tokens</span><span id="tokenSummary">-</span></div>
      </div>
    </header>

    <div class="app-layout">
    <aside class="session-dock session-rail card">
      <div class="section-head">
        <h2>Sessions</h2>
        <div class="dock-controls">
          <button
            id="sessionRailToggleBtn"
            class="icon-btn session-icon-btn"
            type="button"
            aria-label="Collapse sessions panel"
            title="Collapse sessions panel"
          >
            <svg class="icon session-toggle-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="m15 6-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button
            id="newSessionBtn"
            class="icon-btn session-icon-btn"
            type="button"
            aria-label="New session"
            title="New session"
          >
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <button
            id="refreshSessionsBtn"
            class="icon-btn session-icon-btn"
            type="button"
            aria-label="Refresh sessions"
            title="Refresh sessions"
          >
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M20 12a8 8 0 1 1-2.34-5.66" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M20 4v6h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
      <div id="sessionList" class="session-list"></div>
    </aside>

    <div class="app-main">
    <section class="prompt-dock card">
      <label for="task" class="dock-label">Research Task</label>
      <div class="task-run-row">
        <textarea id="task" rows="3" placeholder="Ask a deep research question..."></textarea>
        <button id="runBtn" class="primary">Start Research</button>
      </div>
      <details>
        <summary>Advanced controls</summary>
        <div class="dock-controls">
          <button id="pauseBtn" type="button" disabled>Pause Research</button>
          <button id="resumeBtn" type="button" disabled>Resume Research</button>
          <button id="abortBtn" type="button" disabled>Abort Research</button>
        </div>
        <div class="advanced-grid">
          <label>Max depth <input id="maxDepth" type="number" value="{{ default_max_depth }}" min="{{ max_depth_min }}" max="{{ max_depth_max }}"></label>
          <label>Results/query <input id="resultsPerQuery" type="number" value="{{ default_results_per_query }}" min="{{ results_per_query_min }}" max="{{ results_per_query_max }}"></label>
        </div>
        <section class="context context-in-advanced">
          <div class="section-head">
            <h2>Context</h2>
            <div class="context-head-tools">
              <span id="contextMeta" class="muted">No session selected.</span>
            </div>
          </div>
          <div class="context-controls">
            <input id="contextUploadInput" type="file" multiple />
            <button id="contextUploadBtn" type="button" disabled>Upload Files</button>
          </div>
          <div id="contextDiffBanner" class="muted"></div>
          <div class="context-grid">
            <div class="context-files-pane">
              <h3>Files</h3>
              <div id="contextFiles" class="context-files-list"></div>
            </div>
            <div class="context-digest-pane">
              <h3>Aggregated File Digest</h3>
              <pre id="contextAggregateDigest" class="usage"></pre>
            </div>
          </div>
        </section>
      </details>
      <div id="runMeta" class="muted"></div>
      <div id="stopReason" class="stop-reason"></div>
      <div id="errorBanner" class="error hidden" aria-live="polite"></div>
    </section>

    <main class="content-grid">
      <section class="canvas card">
        <div class="section-head">
          <h2>Research Canvas</h2>
          <div class="canvas-toolbar">
            <span id="canvasHint" class="muted">Auto-fit</span>
            <button id="zoomOutBtn" type="button">-</button>
            <span id="zoomPct" class="zoom-pct">100%</span>
            <button id="zoomInBtn" type="button">+</button>
            <button id="zoomFitBtn" type="button">Fit</button>
            <span id="fitDebug" class="zoom-debug muted"></span>
          </div>
        </div>
        <div id="canvas" class="canvas-board"></div>
      </section>

      <section class="thoughts card" aria-live="polite">
        <div class="section-head">
          <h2>Thought Stream</h2>
          <span id="latestThought" class="muted"></span>
        </div>
        <div id="thoughtStream" class="thought-list"></div>
      </section>

      <section class="report card">
        <div class="section-head">
          <h2>Report</h2>
          <div class="report-head-tools">
            <button
              id="reportBtn"
              class="icon-btn"
              type="button"
              disabled
              aria-label="Generate report from current findings"
              title="Generate report from current findings"
            >
              <svg class="icon refresh-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M20 12a8 8 0 1 1-2.34-5.66" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M20 4v6h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button
              id="downloadBtn"
              class="icon-btn"
              type="button"
              disabled
              aria-label="Download report"
              title="Download report"
            >
              <svg class="icon download-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 3v12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="m7 10 5 5 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 21h16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
            <button id="reportPrevBtn" type="button" disabled>&lt;</button>
            <span id="reportVersionLabel" class="muted">-/-</span>
            <button id="reportNextBtn" type="button" disabled>&gt;</button>
          </div>
        </div>
        <div id="coverageNote" class="muted"></div>
        <div id="reportRendered" class="report-body rendered"></div>
        <h3>Token Usage</h3>
        <pre id="usage" class="usage"></pre>
      </section>
    </main>
    </div>
    </div>
  </div>
  <script>
    window.APP_CONFIG = {
      min_canvas_zoom: {{ min_canvas_zoom|tojson }},
      auto_fit_safety_px: {{ auto_fit_safety_px|tojson }},
      default_max_depth: {{ default_max_depth|tojson }},
      default_results_per_query: {{ default_results_per_query|tojson }},
      ui_debug: {{ ui_debug|tojson }},
    };
  </script>
  <script src="/static/app_v2.js"></script>
</body>
</html>
