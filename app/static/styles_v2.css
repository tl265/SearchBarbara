:root {
  --bg: #f4f6f8;
  --card: #ffffff;
  --ink: #10212b;
  --muted: #5f7280;
  --line: #d5dde3;
  --brand: #0f766e;
  --danger: #b91c1c;
  --queued: #94a3b8;
  --running: #0ea5e9;
  --success: #16a34a;
  --failed: #dc2626;
  --skipped: #64748b;
  --stopped: #9a3412;
  --sufficient: #0f766e;
}

* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
  color: var(--ink);
  background: radial-gradient(circle at top left, #e8f4ef 0%, var(--bg) 45%, #edf2f7 100%);
  overflow-x: hidden;
}

.app-shell {
  max-width: 1560px;
  width: 100%;
  margin: 0 auto;
  padding: 14px;
}

.topbar {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  gap: 12px;
  margin-bottom: 10px;
}

h1 { margin: 0; font-size: 1.4rem; }
.subtitle { margin: 2px 0 0; color: var(--muted); font-size: 0.9rem; }
.auth-box {
  display: flex;
  align-items: center;
  gap: 8px;
}
.auth-box form {
  margin: 0;
}

.top-metrics {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 0.86rem;
}
.top-metrics {
  display: none;
}
.top-metrics div {
  background: #fff;
  border: 1px solid var(--line);
  border-radius: 999px;
  padding: 4px 10px;
  display: flex;
  gap: 8px;
}
.top-metrics .k { color: var(--muted); }

.card {
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 12px;
}

.prompt-dock { margin-bottom: 10px; }
.session-dock { margin-bottom: 10px; }
.context { margin-bottom: 10px; }
.context-in-advanced {
  margin-top: 12px;
  margin-bottom: 0;
}
.dock-label { display: block; font-weight: 600; margin-bottom: 6px; }
textarea, input {
  width: 100%;
  border: 1px solid var(--line);
  border-radius: 8px;
  padding: 8px;
  font: inherit;
}
textarea { resize: vertical; }
textarea.locked {
  background: #edf2f7;
  color: #4b5563;
  cursor: not-allowed;
}

.dock-controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin: 8px 0;
}
button {
  border: 1px solid #7c8e9b;
  background: #f8fafc;
  border-radius: 9px;
  padding: 8px 12px;
  cursor: pointer;
  font: inherit;
}
button.primary {
  background: var(--brand);
  border-color: var(--brand);
  color: #fff;
}
button:disabled {
  opacity: 0.65;
  cursor: not-allowed;
}

.advanced-grid {
  margin-top: 8px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  gap: 8px;
}
.advanced-grid label { font-size: 0.9rem; }

.context-head-tools {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.context-controls {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin: 8px 0;
}
#contextUploadInput {
  display: none;
}
.context-grid {
  display: grid;
  grid-template-columns: minmax(280px, 0.8fr) minmax(360px, 1.2fr);
  gap: 10px;
}
.context-files-pane,
.context-digest-pane {
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 8px;
  background: #fbfdff;
}
.context-files-list {
  max-height: 260px;
  overflow: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.context-file-row {
  border: 1px solid var(--line);
  border-radius: 8px;
  padding: 6px;
  background: #fff;
}
.context-file-main {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  align-items: center;
}
.context-file-name {
  font-weight: 600;
  font-size: 0.9rem;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.context-file-meta {
  font-size: 0.8rem;
  color: var(--muted);
}
.context-file-actions {
  margin-top: 6px;
  display: inline-flex;
  gap: 6px;
  flex-wrap: wrap;
}
.context-chip {
  border: 1px solid var(--line);
  border-radius: 999px;
  font-size: 0.75rem;
  padding: 2px 8px;
}
.context-chip.ready { border-color: #16a34a; color: #166534; background: #dcfce7; }
.context-chip.parsing { border-color: #0284c7; color: #0c4a6e; background: #e0f2fe; }
.context-chip.stale { border-color: #64748b; color: #334155; background: #e2e8f0; }
.context-chip.error { border-color: #dc2626; color: #7f1d1d; background: #fee2e2; }

@media (max-width: 980px) {
  .context-grid {
    grid-template-columns: 1fr;
  }
}

.session-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-height: 220px;
  overflow: auto;
}
.session-row {
  border: 1px solid var(--line);
  border-radius: 8px;
  padding: 8px;
  background: #fcfeff;
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 8px;
  align-items: center;
}
.session-row.active {
  border-color: #2563eb;
  box-shadow: 0 0 0 1px #bfdbfe;
}
.session-title {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.session-meta {
  color: var(--muted);
  font-size: 0.82rem;
}
.session-actions {
  display: inline-flex;
  gap: 6px;
}
.session-actions button {
  padding: 4px 8px;
  font-size: 0.82rem;
}

.content-grid {
  display: grid;
  grid-template-columns: 1fr;
  grid-template-areas:
    "canvas"
    "thoughts"
    "report";
  gap: 10px;
  width: 100%;
  min-width: 0;
}
.canvas {
  grid-area: canvas;
  min-height: 360px;
  min-width: 0;
}
.thoughts { grid-area: thoughts; min-height: 160px; max-height: 260px; min-width: 0; }
.report { grid-area: report; min-height: 320px; min-width: 0; }

.section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.report-head-tools {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
h2 { margin: 0; font-size: 1.05rem; }
h3 { margin: 12px 0 6px; font-size: 0.95rem; }

.canvas-board {
  overflow: auto;
  padding: 4px 2px 8px;
  min-height: 320px;
  width: 100%;
  min-width: 0;
}
.canvas-toolbar {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.canvas-toolbar button {
  padding: 3px 8px;
  min-width: 32px;
}
.zoom-pct {
  min-width: 48px;
  text-align: center;
  font-size: 0.84rem;
  color: var(--muted);
}
.zoom-debug {
  font-size: 0.78rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 520px;
  display: none;
}
body.ui-debug-on .zoom-debug {
  display: inline-block;
}
.depth-rows {
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 200px;
  width: max-content;
  min-width: 100%;
}
.depth-row {
  border-left: 3px solid #dbe5ea;
  padding-left: 8px;
  width: max-content;
  min-width: 100%;
}
.depth-row-nodes {
  display: flex;
  gap: 10px;
  flex-wrap: nowrap;
  align-items: stretch;
  justify-content: center;
  overflow-x: hidden;
  overflow-y: visible;
  padding-bottom: 8px;
  width: max-content;
  min-width: 100%;
}
.depth-row-nodes .node {
  width: var(--node-card-width, 340px);
  min-width: var(--node-card-width, 340px);
  flex: 0 0 var(--node-card-width, 340px);
}
.depth-title {
  font-size: 0.82rem;
  color: var(--muted);
  margin: 0 0 6px;
}

.node {
  position: relative;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: calc(8px * var(--node-font-scale, 1));
  margin-bottom: 8px;
  background: #fbfdff;
  overflow: hidden;
  font-size: calc(14px * var(--node-font-scale, 1));
}
.node.state-active {
  background: #fbfdff;
  border-color: var(--line);
  box-shadow: none;
}
.node.state-active.active-running {
  border-color: #2563eb;
  box-shadow: 0 0 0 2px #bfdbfe;
}
.node.state-active.active-decomposed {
  border-color: #93c5fd;
  box-shadow: 0 0 0 1px #dbeafe;
}
.node.state-visited {
  background: #f8fafc;
  border-color: #cbd5e1;
}
.node.state-visited.visited-solved {
  background: #eafaf0;
  border-color: #22c55e;
  box-shadow: inset 0 0 0 1px #bbf7d0;
}
.node.state-visited.visited-unresolved {
  background: #fffbeb;
  border-color: #f59e0b;
  box-shadow: inset 0 0 0 1px #fde68a;
}
.node.state-planned {
  background: #fbfdff;
  border-color: #cbd5e1;
}
.node.active-emphasis .node-title,
.node.active-emphasis .query-mini,
.node.active-emphasis .node-parent {
  font-weight: 600;
}
.node.has-parent::before {
  content: "";
  position: absolute;
  top: -10px;
  left: 18px;
  width: 2px;
  height: 10px;
  background: #c5d8e6;
}
.node.dimmed { opacity: 0.5; filter: saturate(0.8); }
.node.running { border-color: var(--running); box-shadow: 0 0 0 2px #e0f2fe; }
.node.success { border-color: var(--success); }
.node.failed { border-color: var(--failed); }
.node.sufficient { border-color: var(--sufficient); }
.node.stopped, .node.dead_end { border-color: var(--stopped); }

.node-head {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
  margin-bottom: 6px;
  font-size: 0.84em;
  min-width: 0;
}
.badge {
  border-radius: 999px;
  border: 1px solid var(--line);
  padding: 1px 7px;
  background: #fff;
  max-width: 100%;
  overflow-wrap: anywhere;
}
.badge.running { border-color: var(--running); color: #0369a1; }
.badge.success { border-color: var(--success); color: #166534; }
.badge.failed { border-color: var(--failed); color: #991b1b; }
.badge.skipped { border-color: var(--skipped); color: #334155; }
.badge.stopped, .badge.dead_end { border-color: var(--stopped); color: #7c2d12; }
.badge.sufficient { border-color: var(--sufficient); color: #115e59; }

.node-title {
  margin: 0 0 4px;
  font-size: 0.93em;
  line-height: 1.35;
  overflow-wrap: anywhere;
  word-break: break-word;
}
.node-parent { margin: 0 0 6px; font-size: 0.78em; color: var(--muted); }
.node-parent {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #eef5fa;
  border: 1px solid #d3e0ea;
  border-radius: 999px;
  padding: 2px 8px;
}
.node-parent .parent-link {
  position: relative;
  color: #486070;
  padding-left: 14px;
}
.node-parent .parent-link::before {
  content: "";
  position: absolute;
  left: 0;
  top: 50%;
  width: 10px;
  border-top: 1.5px solid #8fb1c7;
  transform: translateY(-50%);
}

.query-list { margin: 0; padding-left: 14px; }
.query-list li { margin-bottom: 5px; }
.query-list li > div {
  overflow-wrap: anywhere;
  word-break: break-word;
}
.query-list li + li {
  border-top: 1px dashed var(--line);
  padding-top: 7px;
  margin-top: 7px;
}
.query-mini {
  font-size: 0.79em;
  color: var(--muted);
  overflow-wrap: anywhere;
  word-break: break-word;
}

details.query-details {
  margin-top: 5px;
}
.query-details summary { cursor: pointer; }
.query-meta {
  font-size: 0.79em;
  color: var(--muted);
  overflow-wrap: anywhere;
  word-break: break-word;
}
.source-links {
  margin: 4px 0 0;
  padding-left: 16px;
}
.source-links li {
  margin: 2px 0;
}
.source-links a {
  color: #0f5f8f;
  text-decoration: underline;
}
.source-host {
  color: var(--muted);
  font-size: 0.92em;
}

details.node-section {
  margin-top: 7px;
  border-top: 1px dashed var(--line);
  padding-top: 6px;
}
.node-section summary {
  cursor: pointer;
  color: #456074;
  font-size: 0.83em;
}

.thought-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 190px;
  overflow: auto;
}
.thought {
  border: 1px solid var(--line);
  border-left: 3px solid #93c5fd;
  border-radius: 8px;
  padding: 7px 8px;
  background: #f8fbff;
  font-size: 0.86rem;
}
.thought .t-meta { color: var(--muted); font-size: 0.75rem; margin-bottom: 2px; }

.report-body {
  border: 1px solid var(--line);
  border-radius: 8px;
  background: #f8fafc;
  padding: 10px;
  min-height: 180px;
  max-height: 520px;
  overflow: auto;
  white-space: pre-wrap;
}
.report-body.rendered h1,
.report-body.rendered h2,
.report-body.rendered h3 { margin-top: 0.9em; margin-bottom: 0.35em; }
.report-body.rendered p { margin: 0.55em 0; }
.report-body.rendered ul { margin: 0.35em 0 0.55em; }
.usage {
  border: 1px solid var(--line);
  border-radius: 8px;
  background: #f8fafc;
  padding: 8px;
  white-space: pre-wrap;
}

.stop-reason {
  margin-top: 6px;
  font-size: 0.9rem;
  color: #0f5132;
}
.error {
  margin-top: 8px;
  padding: 8px;
  border-radius: 8px;
  background: #fee2e2;
  color: #991b1b;
}
.hidden { display: none; }
.muted { color: var(--muted); font-size: 0.84rem; }
.raw-toggle { font-size: 0.85rem; color: var(--muted); }

@media (max-width: 1100px) {
  .content-grid {
    grid-template-columns: 1fr;
    grid-template-areas:
      "canvas"
      "thoughts"
      "report";
  }
  .thought-list {
    max-height: 190px;
  }
  .depth-row-nodes .node {
    width: var(--node-card-width, 340px);
    min-width: var(--node-card-width, 340px);
    flex-basis: var(--node-card-width, 340px);
  }
}
